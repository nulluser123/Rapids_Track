<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Chess Tracker Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="style.css">
</head>

<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white font-display min-h-screen flex overflow-hidden">
    <!-- Sidebar -->
    <aside
        class="w-64 bg-card-light dark:bg-background-dark border-r border-slate-200 dark:border-slate-800 flex-col hidden md:flex z-10 relative">
        <div class="h-16 flex items-center px-6 border-b border-slate-200 dark:border-slate-800">
            <div class="flex items-center gap-3">
                <div class="bg-primary/10 p-2 rounded-lg">
                    <span class="material-symbols-outlined text-primary">chess</span>
                </div>
                <h1 class="text-lg font-bold tracking-tight">Chess Tracker</h1>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto py-6 px-4 flex flex-col gap-1">
            <a class="flex items-center gap-3 px-4 py-3 rounded-lg bg-primary text-white shadow-md shadow-primary/20 transition-all"
                href="#">
                <span class="material-symbols-outlined">dashboard</span>
                <span class="font-medium text-sm">Dashboard</span>
            </a>
            <a class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
                href="#">
                <span class="material-symbols-outlined">group</span>
                <span class="font-medium text-sm">Players</span>
            </a>
            <a class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
                href="#">
                <span class="material-symbols-outlined">bar_chart</span>
                <span class="font-medium text-sm">Analytics</span>
            </a>
            <a class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
                href="#">
                <span class="material-symbols-outlined">settings</span>
                <span class="font-medium text-sm">Settings</span>
            </a>
        </div>
        <div class="p-4 border-t border-slate-200 dark:border-slate-800">
            <div class="flex items-center gap-3 px-2">
                <div class="size-8 rounded-full bg-cover bg-center"
                    style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuB4K4GqX_wukp7czzWzI5fU8Vj0BIj5lGgb2M_bmRdvilv3ERcyFjiwlGuCrWJsB_LsU5DHbRt9-naA13khWGpV-PspJkx4f78_5kDVKj5CDdsGzjkwOioaEuQWOY4CEKRS9vgO4Xn57JhDPfw0Ow-5Zxgt9F9HVTzME5S7r_VdarwDVe7-8Ln8EBZMaO2WuDQV1RbNoFrWafdYTDBwyMNZD4X6cR_W0qOX3h08cJaTzbK5b4F8hFPrne9COESRPrY_aXg3qjcfKH0U');">
                </div>
                <div class="flex flex-col">
                    <p class="text-xs font-bold">Admin User</p>
                    <p class="text-[10px] text-slate-500 dark:text-slate-400">Pro Plan</p>
                </div>
            </div>
        </div>
    </aside>
    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <!-- Header -->
        <header
            class="h-16 bg-card-light dark:bg-background-dark/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-4 sm:px-8 z-20">
            <div class="flex items-center gap-4 md:hidden">
                <button class="text-slate-500 hover:text-primary">
                    <span class="material-symbols-outlined">menu</span>
                </button>
                <span class="font-bold text-lg">Chess Tracker</span>
            </div>
            <!-- Search Bar -->
            <div class="hidden md:flex flex-1 max-w-md">
                <div class="relative w-full group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <span
                            class="material-symbols-outlined text-slate-400 group-focus-within:text-primary transition-colors">search</span>
                    </div>
                    <input
                        class="block w-full pl-10 pr-3 py-2 border-none rounded-lg leading-5 bg-slate-100 dark:bg-slate-800/50 text-slate-900 dark:text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-primary/50 sm:text-sm transition-all"
                        placeholder="Search player by username..." type="text" id="usernameInput" />
                </div>
            </div>
            <!-- Actions -->
            <div class="flex items-center gap-3">
                <button class="md:hidden p-2 text-slate-500">
                    <span class="material-symbols-outlined">search</span>
                </button>
                <div class="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-1"></div>
                <button
                    class="flex items-center gap-2 bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors shadow-lg shadow-primary/25"
                    id="addPlayerBtn">
                    <span class="material-symbols-outlined text-[20px]">add</span>
                    <span class="hidden sm:inline">Add Player</span>
                </button>
            </div>
        </header>
        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-4 sm:p-8 space-y-8">
            <!-- Page Heading -->
            <div class="flex flex-col gap-1">
                <h2 class="text-3xl font-black tracking-tight">Dashboard</h2>
                <p class="text-slate-500 dark:text-slate-400" id="status">Track real-time ratings and compare top players.</p>
            </div>
            <!-- Global Standings Chart -->
            <section
                class="bg-card-light dark:bg-card-dark rounded-xl p-6 shadow-sm border border-slate-200 dark:border-slate-700/50">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white">Global Standings</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Current Rapid Rating (Top 5)</p>
                    </div>
                    <div class="text-right">
                        <p class="text-2xl font-bold text-primary" id="avg-rating">0</p>
                        <p class="text-xs font-medium text-slate-500 uppercase tracking-wider">Avg Rating</p>
                    </div>
                </div>
                <div class="space-y-4" id="global-standings">
                    <!-- Chart Bar Items will be injected here -->
                </div>
            </section>
            <!-- Grid Header -->
            <div class="flex items-center justify-between">
                <h3 class="text-xl font-bold">Tracked Players</h3>
                <div class="flex gap-2">
                    <button id="refreshAllBtn"
                        class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 transition-colors">
                        <span class="material-symbols-outlined">sync</span>
                    </button>
                    <button
                        class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 transition-colors">
                        <span class="material-symbols-outlined">sort</span>
                    </button>
                </div>
            </div>
            <!-- Player Cards Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="player-cards-grid">
                <!-- Player cards will be injected here -->
            </div>
            <!-- Footer/Note -->
            <div class="py-6 text-center text-xs text-slate-500">
                <p>Data synced from Chess.com API. Last updated: Just now.</p>
            </div>
        </div>
    </main>
    <script>
        // === STATE ===
        let players = [];
        const DEFAULT_PLAYERS = [ ];

        // === STORAGE ===
        function loadPlayers() {
            try {
                const stored = localStorage.getItem('chessRatingTracker');
                if (stored) {
                    const data = JSON.parse(stored);
                    players = data.players || [];
                    // Backfill history if missing
                    players.forEach(p => {
                        if (!p.history) p.history = [];
                    });
                } else {
                    players = DEFAULT_PLAYERS.map(username => ({
                        username,
                        rapidRating: null,
                        previousRating: null,
                        lastUpdated: null,
                        history: []
                    }));
                    savePlayers();
                }
            } catch (error) {
                setStatus('Load Failed', 'error');
            }
        }

        function savePlayers() {
            try {
                // We preserve historyData key if it exists in localstorage to not break backward compatibility
                // but we don't use it in this UI version
                const existing = localStorage.getItem('chessRatingTracker');
                const existingData = existing ? JSON.parse(existing) : {};
                
                const data = { 
                    players,
                    historyData: existingData.historyData || {} 
                };
                localStorage.setItem('chessRatingTracker', JSON.stringify(data));
            } catch (e) { console.error(e); }
        }

        // === UI RENDERING ===
        function updateUI() {
            const list = document.getElementById('player-cards-grid');
            list.innerHTML = '';

            // Optimization: Get color once per update cycle
            const computedStyle = getComputedStyle(document.body);
            const strokeColor = computedStyle.getPropertyValue('--text-primary').trim();

            // Sort: High Rating -> Low Rating -> No Rating
            const sorted = [...players].sort((a, b) => {
                if (a.rapidRating === null) return 1;
                if (b.rapidRating === null) return -1;
                return b.rapidRating - a.rapidRating;
            });

            sorted.forEach((p, index) => {
                const card = document.createElement('div');
                card.className = 'bg-card-light dark:bg-card-dark rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-700/50 hover:border-primary/50 transition-colors group cursor-pointer';

                // Calculate diff
                let diffHtml = '';
                if (p.previousRating !== null && p.rapidRating !== null) {
                    const diff = p.rapidRating - p.previousRating;
                    if (diff > 0) {
                        diffHtml = `<div class="flex items-center gap-1 text-emerald-500 bg-emerald-500/10 px-2 py-1 rounded text-xs font-bold">
                                        <span class="material-symbols-outlined text-[14px]">trending_up</span>
                                        <span>+${diff}</span>
                                    </div>`;
                    } else if (diff < 0) {
                        diffHtml = `<div class="flex items-center gap-1 text-rose-500 bg-rose-500/10 px-2 py-1 rounded text-xs font-bold">
                                        <span class="material-symbols-outlined text-[14px]">trending_down</span>
                                        <span>${diff}</span>
                                    </div>`;
                    } else {
                        diffHtml = `<div class="flex items-center gap-1 text-slate-500 bg-slate-500/10 px-2 py-1 rounded text-xs font-bold">
                                        <span class="material-symbols-outlined text-[14px]">remove</span>
                                        <span>0</span>
                                    </div>`;
                    }
                }

                const ratingDisplay = p.rapidRating ? p.rapidRating : '---';

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full bg-slate-800 bg-cover bg-center border-2 border-slate-700"
                                style="background-image: url('${p.avatar || ''}');"></div>
                            <div>
                                <h4 class="font-bold text-base leading-tight">${p.username}</h4>
                                <p class="text-xs text-slate-500 dark:text-slate-400">${p.title || 'Player'}</p>
                            </div>
                        </div>
                        <button class="text-slate-500 hover:text-white transition-colors opacity-0 group-hover:opacity-100" onclick="removePlayer('${p.username}')">
                            <span class="material-symbols-outlined text-[20px]">close</span>
                        </button>
                    </div>
                    <div class="flex items-baseline gap-2 mb-1">
                        <span class="text-4xl font-bold tracking-tight">${ratingDisplay}</span>
                        <span class="text-xs font-bold uppercase text-slate-500 tracking-wider">Rapid</span>
                    </div>
                    <div class="flex items-center gap-4 mt-4 pt-4 border-t border-slate-100 dark:border-slate-700/50">
                        ${diffHtml}
                        <div class="flex flex-col">
                            <span class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Peak Rating</span>
                            <span class="text-sm font-medium">${p.peakRating || 'N/A'}</span>
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });

            updateGlobalStandings(sorted);
        }

        function updateGlobalStandings(sortedPlayers) {
            const standings = document.getElementById('global-standings');
            standings.innerHTML = '';

            const top5 = sortedPlayers.filter(p => p.rapidRating !== null).slice(0, 5);

            if (top5.length === 0) return;

            const maxRating = Math.max(...top5.map(p => p.rapidRating));
            const avgRating = Math.round(top5.reduce((sum, p) => sum + p.rapidRating, 0) / top5.length);

            document.getElementById('avg-rating').textContent = avgRating;

            top5.forEach(p => {
                const bar = document.createElement('div');
                bar.className = 'grid grid-cols-[100px_1fr_60px] items-center gap-4 group';

                const widthPercentage = (p.rapidRating / maxRating) * 100;

                bar.innerHTML = `
                    <div class="text-sm font-semibold text-right truncate">${p.username}</div>
                    <div class="h-3 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                        <div class="h-full bg-primary rounded-full relative group-hover:bg-blue-400 transition-colors duration-300" style="width: ${widthPercentage}%"></div>
                    </div>
                    <div class="text-sm font-mono text-slate-500 text-right">${p.rapidRating}</div>
                `;
                standings.appendChild(bar);
            });
        }

        function setStatus(msg, type = '') {
            const el = document.getElementById('status');
            el.textContent = msg;
        }

        // === ACTIONS ===
        function addPlayer() {
            const input = document.getElementById('usernameInput');
            const name = input.value.trim();
            if (!name) return;
            
            if (players.some(p => p.username.toLowerCase() === name.toLowerCase())) {
                setStatus('Player exists', 'error');
                return;
            }

            players.push({ username: name, rapidRating: null, previousRating: null, lastUpdated: null, history: [] });
            savePlayers();
            updateUI();
            input.value = '';
            setStatus(`Added ${name}`);
        }

        window.removePlayer = function(username) {
            if(!confirm(`Remove ${username}?`)) return;
            players = players.filter(p => p.username !== username);
            savePlayers();
            updateUI();
        };

        async function fetchPlayerData(username) {
            const statsRes = await fetch(`https://api.chess.com/pub/player/${username}/stats`);
            if (!statsRes.ok) throw new Error(statsRes.status);
            const statsData = await statsRes.json();

            const profileRes = await fetch(`https://api.chess.com/pub/player/${username}`);
            if (!profileRes.ok) throw new Error(profileRes.status);
            const profileData = await profileRes.json();

            return {
                rating: statsData.chess_rapid?.last?.rating || null,
                date: statsData.chess_rapid?.last?.date || null,
                avatar: profileData.avatar || '',
                title: profileData.title || ''
            };
        }

        async function refreshAll() {
            const btn = document.getElementById('refreshAllBtn');
            btn.disabled = true;
            btn.querySelector('span').classList.add('animate-spin');
            setStatus('Fetching data...');

            let errors = 0;
            for (let i = 0; i < players.length; i++) {
                const p = players[i];
                try {
                    const result = await fetchPlayerData(p.username);
                    if (result.rating !== null) {
                        if (!p.history) p.history = [];
                        const lastStored = p.history.length > 0 ? p.history[p.history.length - 1] : null;

                        if (lastStored === null || lastStored !== result.rating) {
                            p.history.push(result.rating);
                            if (p.history.length > 5) p.history.shift();
                        }

                        p.previousRating = p.rapidRating;
                        p.rapidRating = result.rating;
                        p.lastGameDate = result.date;
                        p.avatar = result.avatar;
                        p.title = result.title;
                        p.lastUpdated = Date.now();

                        if (!p.peakRating || p.rapidRating > p.peakRating) {
                            p.peakRating = p.rapidRating;
                        }
                    }
                } catch (e) {
                    console.error(e);
                    errors++;
                }
            }

            savePlayers();
            updateUI();
            btn.disabled = false;
            btn.querySelector('span').classList.remove('animate-spin');
            setStatus(errors > 0 ? `Done with ${errors} errors` : 'All Updated');
        }

        // === INIT ===
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.documentElement.classList.remove('dark');
            } else {
                document.documentElement.classList.add('dark');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadPlayers();
            updateUI();
            initTheme();

            document.getElementById('addPlayerBtn').addEventListener('click', addPlayer);
            document.getElementById('refreshAllBtn').addEventListener('click', refreshAll);
        });
    </script>
</body>
</html>